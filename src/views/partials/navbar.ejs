<nav class="prontmed-navbar d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
        <span class="logo me-4">OpenPront</span>
        <div class="dropdown prontmed-search-container">
            <input type="text" class="form-control prontmed-search" placeholder="buscar pacientes"
                id="search-paciente-input" autocomplete="off" data-bs-toggle="dropdown" aria-expanded="false">
            <ul class="dropdown-menu prontmed-suggestions-card"
                aria-labelledby="search-paciente-input" id="paciente-suggestions-list">
            </ul>
        </div>
    </div>
    <div class="d-flex align-items-center">
        <ul class="navbar-nav flex-row nav-links-container">
            <li class="nav-item">
                <a href="/agenda" class="nav-link" data-path="agenda">agenda</a>
            </li>
            <li class="nav-item">
                <a href="/pacientes" class="nav-link" data-path="pacientes">pacientes</a>
            </li>
            <li class="nav-item">
                <a href="/relatorios" class="nav-link" data-path="relatorios">relatórios</a>
            </li>

            <% if (user.role==="ADMIN" ) { %>
                <li class="nav-item">
                    <a href="/medicos" class="nav-link" data-path="medicos">médicos</a>
                </li>
                <li class="nav-item">
                    <a href="/usuarios" class="nav-link" data-path="usuarios">usuários</a>
                </li>
            <% } %>

            <li class="nav-item">
                <a href="/recursos" class="nav-link" data-path="recursos">recursos</a>
            </li>
        </ul>

        <div class="dropdown ms-3">
            <a href="#" class="text-white text-decoration-none" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle fs-5"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuLink">
                <li>
                    <h6 class="dropdown-header">
                        <%= user.nome %>
                    </h6>
                </li>
                <li><a class="dropdown-item" href="/perfil">Meu Perfil</a></li>
                <% if (user.role==="ADMIN" ) { %>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" href="/admin/config">Configurações</a></li>
                <% } %>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item text-danger" href="/logout">Sair</a></li>
            </ul>
        </div>
    </div>
</nav>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('search-paciente-input');
        const suggestionsList = document.getElementById('paciente-suggestions-list');
        const searchDropdown = bootstrap.Dropdown.getOrCreateInstance(input.parentElement); // Initialize once
        let searchTimeout;

        // =========================================================
        // 1. Marcação da Página Atual (Ativar Link do Menu)
        // =========================================================
        const highlightCurrentPage = () => {
            const pathSegments = window.location.pathname.split('/');
            const rootPath = pathSegments[1] || 'agenda';
            
            const navLinks = document.querySelectorAll('.nav-links-container .nav-link');

            navLinks.forEach(link => {
                link.classList.remove('active');
                
                const linkPath = link.getAttribute('data-path'); 

                if (linkPath === rootPath) {
                    link.classList.add('active');
                }
            });
        };

        highlightCurrentPage();

        // =========================================================
        // 2. Lógica de Busca de Pacientes (Busca e Renderização)
        // =========================================================

        const fetchSuggestions = async (query) => {
            if (query.length < 3) {
                searchDropdown.hide();
                return;
            }
            
            suggestionsList.innerHTML = `<li><a class="dropdown-item disabled">Carregando...</a></li>`;
            searchDropdown.show();


            try {
                const response = await fetch(`/pacientes/search?q=${encodeURIComponent(query)}`);
                const pacientesData = await response.json();
                
                renderSuggestions(pacientesData.pacientes || []); 

            } catch (error) {
                console.error('Erro ao buscar pacientes:', error);
                suggestionsList.innerHTML = `<li><a class="dropdown-item text-danger">Falha na conexão ou API.</a></li>`;
            }
        };

        const renderSuggestions = (pacientes) => {
            suggestionsList.innerHTML = '';

            if (pacientes.length === 0) {
                suggestionsList.innerHTML = `<li><a class="dropdown-item disabled">Nenhum paciente encontrado.</a></li>`;
                searchDropdown.show();
                return;
            }

            pacientes.forEach(paciente => {
                const li = document.createElement('li');
                const newRoute = `/pacientes/${paciente.id}/ficha`;

                li.innerHTML = `
                    <a class="dropdown-item paciente-suggestion-item" href="${newRoute}">
                        <div class="name">${paciente.nome}</div>
                        <div class="details">${paciente.cpf ? `CPF: <strong>${paciente.cpf}</strong>` : ''}</div>
                    </a>
                `;
                suggestionsList.appendChild(li);
            });

            searchDropdown.show();
        };

        input.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            clearTimeout(searchTimeout);

            searchTimeout = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        });
        
        document.addEventListener('click', (e) => {
            if (!input.parentElement.contains(e.target)) {
                searchDropdown.hide();
            }
        });
    });
</script>