<link rel="stylesheet" href="../../assets/css/atendimento_styles.css">


<% const todayDate=new Date(); const formattedDate=todayDate.toLocaleDateString('pt-BR', { weekday: 'long' ,
    day: '2-digit' , month: 'long' , year: 'numeric' }); /* Cálculo de idade */ let idade='--' ; if (agendamento &&
    agendamento.paciente && agendamento.paciente.nascimento) { const nascimento=new
    Date(agendamento.paciente.nascimento); idade=todayDate.getFullYear() - nascimento.getFullYear(); const
    m=todayDate.getMonth() - nascimento.getMonth(); if (m < 0 || (m===0 && todayDate.getDate() < nascimento.getDate()))
    { idade--; } } /* Fallback para foto */ let patientPhoto='' ; if (agendamento && agendamento.paciente &&
    agendamento.paciente.foto) { patientPhoto=`<img src="${agendamento.paciente.foto}"
    class="patient-avatar-large shadow-sm">`;
    } else if (agendamento && agendamento.paciente && agendamento.paciente.nome) {
    patientPhoto = `<div class="patient-avatar-large shadow-sm">${agendamento.paciente.nome.charAt(0).toUpperCase()}
    </div>`;
    } else {
    patientPhoto = `<div class="patient-avatar-large shadow-sm"><i class="bi bi-person"></i></div>`;
    }
    %>


    <div class="atendimento-layout">
        <!-- 1. CLINICAL SIDEBAR (LEFT) -->
        <aside class="clinical-sidebar">
            <div class="sidebar-header">
                <div class="position-relative d-inline-block">
                    <%- patientPhoto %>
                        <span
                            class="position-absolute bottom-0 end-0 bg-success border border-white border-3 rounded-circle"
                            style="width: 20px; height: 20px;"></span>
                </div>
                <h4 class="fw-bold text-dark mt-3 mb-1">
                    <%= (agendamento && agendamento.paciente) ? agendamento.paciente.nome : 'Paciente' %>
                </h4>
                <div class="text-muted small fw-medium mb-3">
                    ID: PM-<%= (agendamento && agendamento.paciente) ? String(agendamento.paciente.id).padStart(4, '0' )
                        : '0000' %>
                </div>

                <div class="patient-dna-badges">
                    <span class="dna-badge badge-info">
                        <%= idade %> Anos
                    </span>
                    <span class="dna-badge badge-success">Sanguíneo <%= (agendamento && agendamento.paciente &&
                            agendamento.paciente.tipoSanguineo) ? agendamento.paciente.tipoSanguineo : 'N/I' %></span>
                    <% if (agendamento && agendamento.paciente && agendamento.paciente.alergias) { %>
                        <span class="dna-badge badge-risk text-truncate" style="max-width: 100px;">Alergia</span>
                        <% } else { %>
                            <span class="dna-badge badge-info">Sem Alergias</span>
                            <% } %>
                </div>
            </div>

            <div class="p-4 flex-grow-1 overflow-auto">
                <div class="helper-title"><i class="bi bi-info-circle"></i> Informações Clínicas</div>

                <div class="mb-4">
                    <div class="d-flex align-items-center gap-3 mb-3 p-3 bg-light rounded-4">
                        <div class="bg-white p-2 rounded-circle shadow-sm"><i class="bi bi-heart-pulse text-danger"></i>
                        </div>
                        <div>
                            <div class="small text-muted fw-bold">PRESSÃO ART.</div>
                            <div class="fw-bold">120/80 <span class="text-muted fw-normal small">mmHg</span></div>
                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-3 mb-3 p-3 bg-light rounded-4">
                        <div class="bg-white p-2 rounded-circle shadow-sm"><i
                                class="bi bi-speedometer2 text-primary"></i></div>
                        <div>
                            <div class="small text-muted fw-bold">GLICEMIA</div>
                            <div class="fw-bold">94 <span class="text-muted fw-normal small">mg/dL</span></div>
                        </div>
                    </div>
                </div>

                <div class="helper-title"><i class="bi bi-clock-history"></i> Histórico Recente</div>
                <div class="timeline-container px-2">
                    <div class="timeline-item">
                        <div class="small fw-bold text-primary">Hoje</div>
                        <div class="small fw-medium">Consulta: <%= (agendamento && agendamento.tipoConsulta) ?
                                agendamento.tipoConsulta : 'N/A' %>
                        </div>
                    </div>
                    <div class="timeline-item opacity-50">
                        <div class="small fw-bold">12 Out 2025</div>
                        <div class="small">Check-up Cardiovascular</div>
                    </div>
                    <div class="timeline-item opacity-50">
                        <div class="small fw-bold">15 Ago 2025</div>
                        <div class="small">Exame: Hemograma Completo</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 2. CLINICAL MAIN (CENTER) -->
        <main class="clinical-main">
            <div class="record-container">
                <!-- Breadcrumbs / Top Status -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <span class="badge bg-white text-muted border text-uppercase px-3 py-2 rounded-pill fw-bold"
                            style="font-size: 0.65rem;">
                            <i class="bi bi-calendar3 me-2"></i>
                            <%= formattedDate %>
                        </span>
                        <span
                            class="badge bg-primary-subtle text-primary border border-primary-subtle px-3 py-2 rounded-pill fw-bold ms-2"
                            style="font-size: 0.65rem;">
                            <i class="bi bi-person-badge me-2"></i>DR. <%= (agendamento && agendamento.medico) ?
                                agendamento.medico.nome.toUpperCase() : 'PROFISSIONAL' %>
                        </span>
                    </div>
                    <div>
                        <button class="btn btn-white border rounded-pill btn-sm fw-bold px-3">
                            <i class="bi bi-printer me-2"></i>IMPRIMIR
                        </button>
                    </div>
                </div>

                <h2 class="fw-800 text-dark mb-4">Evolução Clínica</h2>

                <!-- SMART EDITOR -->
                <div class="smart-editor-container" id="editor-container">
                    <div class="editor-toolbar">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light border-0"><i class="bi bi-type-bold"></i></button>
                            <button class="btn btn-sm btn-light border-0"><i class="bi bi-type-italic"></i></button>
                            <button class="btn btn-sm btn-light border-0"><i class="bi bi-list-ul"></i></button>
                        </div>
                        <div class="v-line mx-2" style="width: 1px; height: 20px; background: #e2e8f0;"></div>
                        <button class="btn btn-sm btn-outline-primary border-0 rounded-pill px-3 fw-bold"
                            title="Inserir modelo médico">
                            <i class="bi bi-journal-medical me-2"></i>MODELOS
                        </button>
                        <div class="ms-auto d-flex align-items-center">
                            <span id="save-status" class="small text-muted me-3 opacity-0 transition-all"><i
                                    class="bi bi-cloud-check me-1"></i>Alterações salvas</span>
                            <div
                                class="badge bg-success-subtle text-success border-success-subtle border px-3 py-1 rounded-pill small fw-bold">
                                EDITANDO EM TEMPO REAL
                            </div>
                        </div>
                    </div>

                    <div id="medical-editor" class="editor-body" contenteditable="true"
                        data-placeholder="Digite '/' para ver modelos ou inicie sua evolução clínica aqui..."></div>

                    <!-- SLASH MENU (Diferencial) -->
                    <div id="slash-menu" class="slash-menu">
                        <div class="p-2 border-bottom bg-light">
                            <span class="extra-small fw-800 text-muted text-uppercase ls-1">Modelos Rápidos</span>
                        </div>
                        <div class="slash-item" data-template="anamnese">
                            <div class="slash-icon"><i class="bi bi-person-lines-fill"></i></div>
                            <div>
                                <div class="fw-bold small">Anamnese Padrão</div>
                                <div class="extra-small text-muted">Queixa, HPP, Antecedentes...</div>
                            </div>
                        </div>
                        <div class="slash-item" data-template="exame-fisico">
                            <div class="slash-icon"><i class="bi bi-clipboard-pulse"></i></div>
                            <div>
                                <div class="fw-bold small">Exame Físico Geral</div>
                                <div class="extra-small text-muted">Aparelho respiratório, cardio...</div>
                            </div>
                        </div>
                        <div class="slash-item" data-template="prescricao">
                            <div class="slash-icon"><i class="bi bi-capsule"></i></div>
                            <div>
                                <div class="fw-bold small">Receituário de Uso Contínuo</div>
                                <div class="extra-small text-muted">Anti-hipertensivos, Estatinas...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Metadata -->
                <div class="row g-4 mt-4">
                    <div class="col-md-6">
                        <div class="helper-card h-100">
                            <div class="helper-title"><i class="bi bi-search"></i> Diagnóstico (CID-10)</div>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-hash"></i></span>
                                <input type="text" class="form-control border-start-0 ps-0"
                                    placeholder="Pesquisar por nome ou código CID...">
                            </div>
                            <div class="mt-2 d-flex flex-wrap gap-1">
                                <span class="badge bg-light text-dark border p-2 rounded-3 small cursor-pointer">I10 -
                                    Hipertensão essencial</span>
                                <span class="badge bg-light text-dark border p-2 rounded-3 small cursor-pointer">E11 -
                                    Diabetes mellitus</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="helper-card h-100">
                            <div class="helper-title"><i class="bi bi-lock"></i> Notas Internas / Sigilosas</div>
                            <textarea class="form-control border-0 bg-light-subtle rounded-3 p-3 small"
                                placeholder="Estas notas não aparecerão no relatório impresso do paciente..."
                                rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 3. CLINICAL HELPER (RIGHT) -->
        <aside class="clinical-helper">
            <% if (agendamento && agendamento.paciente && agendamento.paciente.alergias) { %>
                <div class="helper-card"
                    style="background: linear-gradient(135deg, #fff 0%, #fff5f5 100%); border-left: 4px solid #ef4444;">
                    <div class="helper-title text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Alertas
                        Críticos</div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="bg-danger-subtle p-2 rounded-circle"><i class="bi bi-capsule text-danger"></i></div>
                        <div>
                            <div class="fw-bold small">Alergia Grave</div>
                            <div class="extra-small text-danger fw-bold text-uppercase">
                                <%= agendamento.paciente.alergias %>
                            </div>
                        </div>
                    </div>
                </div>
                <% } else { %>
                    <div class="helper-card"
                        style="background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%); border-left: 4px solid #22c55e;">
                        <div class="helper-title text-success"><i class="bi bi-check-circle-fill"></i> Status Clínico
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-shield-check text-success"></i>
                            <div class="extra-small text-muted fw-bold">NENHUMA ALERGIA REGISTRADA</div>
                        </div>
                    </div>
                    <% } %>

                        <div class="helper-card">
                            <div class="helper-title"><i class="bi bi-graph-up"></i> Painel de Biometria</div>
                            <div class="vital-grid">
                                <div class="vital-item">
                                    <div class="vital-label">IMC</div>
                                    <div class="vital-value">24.2</div>
                                    <div class="extra-small text-success fw-bold">Normal</div>
                                </div>
                                <div class="vital-item">
                                    <div class="vital-label">TEMP</div>
                                    <div class="vital-value">36.5º</div>
                                    <div class="extra-small text-muted">Estável</div>
                                </div>
                                <div class="vital-item">
                                    <div class="vital-label">PESO</div>
                                    <div class="vital-value">78.5kg</div>
                                    <div class="extra-small text-success"><i class="bi bi-caret-down-fill"></i> -1.2kg
                                    </div>
                                </div>
                                <div class="vital-item">
                                    <div class="vital-label">SAT O2</div>
                                    <div class="vital-value">98%</div>
                                    <div class="extra-small text-success">Ótimo</div>
                                </div>
                            </div>
                        </div>

                        <div class="helper-card flex-grow-1 bg-white">
                            <div class="helper-title text-primary"><i class="bi bi-magic"></i> Assistente Copilot</div>
                            <div class="text-center py-4 opacity-75">
                                <i class="bi bi-stars fs-1 text-primary mb-2 d-block"></i>
                                <div class="small fw-bold">Documentação Inteligente</div>
                                <p class="extra-small text-muted px-2">À medida que você escreve, sugestões de
                                    medicamentos e exames
                                    aparecerão aqui.</p>
                            </div>
                        </div>
        </aside>

        <!-- 4. ACTIONS BAR (FLOAT) -->
        <div class="clinical-actions-bar">
            <div class="d-flex align-items-center gap-4 border-end border-secondary-subtle pe-4 me-2">
                <div class="d-flex align-items-center gap-2">
                    <div class="bg-primary text-white p-1 rounded-circle"
                        style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-mic-fill" style="font-size: 0.7rem;"></i>
                    </div>
                    <span class="text-white extra-small fw-bold">AUDIO ON</span>
                </div>
            </div>

            <div class="d-flex gap-3">
                <button class="btn btn-link text-white text-decoration-none extra-small fw-bold">SALVAR
                    RASCUNHO</button>
                <button class="btn btn-outline-danger btn-sm rounded-pill fw-bold border-0 px-4">CANCELAR</button>
                <button class="btn btn-primary rounded-pill fw-bold px-5 py-2 shadow-lg scale-hover"
                    onclick="finalizarAtendimento()">
                    <i class="bi bi-check2-circle me-2"></i>FINALIZAR ATENDIMENTO
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const editor = document.getElementById('medical-editor');
            const slashMenu = document.getElementById('slash-menu');
            const items = slashMenu.querySelectorAll('.slash-item');

            const templates = {
                'anamnese': `<b>QUEIXA PRINCIPAL:</b><br><br><b>HISTÓRIA DA DOENÇA ATUAL:</b><br><br><b>ANTECEDENTES PESSOAIS:</b><br>- HPP:<br>- Cirurgias:<br>- Alergias:<br><br><b>ANTECEDENTES FAMILIARES:</b><br><br>`,
                'exame-fisico': `<b>EXAME FÍSICO GERAL:</b><br>- BEG, LOTE, cianótico (-), anictérico (-), hidratado.<br><br><b>APARELHO CARDIOVASCULAR:</b><br>- RCR em 2T, bulhas normofonéticas, sem sopros.<br><br><b>APARELHO RESPIRATÓRIO:</b><br>- MV presente universalmente, sem ruídos adventícios.<br><br><b>ABDOMEN:</b><br>- Plano, ruídos hidroaéreos presentes, indolor à palpação profunda.`,
                'prescricao': `<b>MEDICAÇÕES EM USO:</b><br>1. Losartana 50mg --- 1 comprimido ao dia (manhã)<br>2. Hidroclorotiazida 25mg --- 1 comprimido ao dia (manhã)<br>3. Metofmina 850mg --- 2 vezes ao dia (almoço e jantar)`
            };

            editor.addEventListener('keyup', (e) => {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                const range = selection.getRangeAt(0);
                const text = editor.innerText;

                if (text.endsWith('/')) {
                    const rect = range.getBoundingClientRect();
                    slashMenu.style.display = 'block';
                    slashMenu.style.top = (rect.bottom + window.scrollY) + 'px';
                    slashMenu.style.left = rect.left + 'px';
                } else if (e.key === 'Escape' || e.key === ' ') {
                    slashMenu.style.display = 'none';
                }
            });

            items.forEach(item => {
                item.addEventListener('click', () => {
                    const template = item.getAttribute('data-template');
                    insertTemplate(templates[template]);
                    slashMenu.style.display = 'none';
                });
            });

            function insertTemplate(html) {
                editor.focus();
                const content = editor.innerHTML;
                editor.innerHTML = content.replace(/\/(?=[^/]*$)/, html);

                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(editor);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
            }

            // AI Assistant
            const assistantPanel = document.querySelector('.clinical-helper .helper-card.bg-white');
            const keywords = {
                'diabetes': { title: 'Protocolo Diabetes', text: 'Sugerir Hemoglobina Glicada e fundo de olho.' },
                'hipertensão': { title: 'Protocolo Hipertensão', text: 'Verificar microalbuminúria e MAPA se necessário.' },
                'asma': { title: 'Manejo de Asma', text: 'Avaliar técnica de inalação e frequência de crises.' }
            };

            editor.addEventListener('input', () => {
                const text = editor.innerText.toLowerCase();
                let found = false;

                for (const key in keywords) {
                    if (text.includes(key)) {
                        assistantPanel.innerHTML = `
                        <div class="helper-title text-primary"><i class="bi bi-lightbulb-fill"></i> Sugestão Inteligente</div>
                        <div class="p-2 border border-primary-subtle bg-primary-subtle rounded-3 mb-2">
                            <div class="fw-bold small text-primary">${keywords[key].title}</div>
                            <div class="extra-small text-dark">${keywords[key].text}</div>
                        </div>
                        <button class="btn btn-primary btn-sm w-100 rounded-pill extra-small fw-bold">APLICAR PROTOCOLO</button>
                    `;
                        found = true;
                        break;
                    }
                }

                if (!found) {
                    assistantPanel.innerHTML = `
                    <div class="helper-title text-primary"><i class="bi bi-magic"></i> Assistente Copilot</div>
                    <div class="text-center py-4 opacity-75">
                        <i class="bi bi-stars fs-1 text-primary mb-2 d-block"></i>
                        <div class="small fw-bold">Documentação Inteligente</div>
                        <p class="extra-small text-muted px-2">À medida que você escreve, sugestões de medicamentos e exames aparecerão aqui.</p>
                    </div>
                `;
                }

                const status = document.getElementById('save-status');
                status.style.opacity = '1';
                setTimeout(() => { status.style.opacity = '0'; }, 2000);
            });
        });

        function finalizarAtendimento() {
            Swal.fire({
                title: 'Finalizar Atendimento?',
                text: "Deseja concluir o prontuário e gerar o relatório final?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#2563eb',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Sim, Finalizar',
                cancelButtonText: 'Continuar editando'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/agenda';
                }
            })
        }
    </script>