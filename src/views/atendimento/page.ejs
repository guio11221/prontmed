<%
const todayDate = new Date();
const formattedDate = todayDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });

// Cálculo de idade simples para exibição
const nascimento = new Date(agendamento.paciente.nascimento);
const idade = todayDate.getFullYear() - nascimento.getFullYear();
%>


<style>
    :root {
        --prontmed-sidebar-width: 320px;
        --prontmed-accent: #00CCBB;
        --prontmed-dark: #1a202c;
    }

    .atendimento-container {
        height: calc(100vh - 70px);
        overflow: hidden;
        background-color: #f4f7fa;
    }

    /* Sidebar Refinada */
    .paciente-sidebar {
        background-color: #fff;
        border-right: 1px solid #e2e8f0;
        height: 100%;
        overflow-y: auto;
        width: var(--prontmed-sidebar-width);
        flex: 0 0 var(--prontmed-sidebar-width);
        box-shadow: 4px 0 10px rgba(0,0,0,0.02);
    }

    .profile-card {
        padding: 2rem 1.5rem;
        border-bottom: 1px solid #f0f4f8;
        background: linear-gradient(to bottom, #ffffff, #fafcfe);
    }

    .avatar-wrapper {
        position: relative;
        width: 90px;
        height: 90px;
        margin: 0 auto 1rem;
    }

    .avatar-main {
        width: 100%;
        height: 100%;
        border-radius: 24px;
        background: #edf2f7;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.2rem;
        color: #a0aec0;
        border: 3px solid #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .status-indicator {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 18px;
        height: 18px;
        background: #48bb78;
        border: 3px solid #fff;
        border-radius: 50%;
    }

    /* Área Principal */
    .prontuario-main {
        flex: 1;
        height: 100%;
        overflow-y: auto;
        padding: 1.5rem 2.5rem 100px 2.5rem;
    }

    .patient-header-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 2rem;
    }

    .stat-box {
        background: #fff;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
    }

    .stat-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #718096;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--prontmed-dark);
    }

    /* Tabs Estilizadas */
    .nav-tabs-clinical {
        border: none;
        background: #ebf1f5;
        padding: 4px;
        border-radius: 12px;
        display: inline-flex;
        margin-bottom: 1.5rem;
    }

    .nav-tabs-clinical .nav-link {
        border: none;
        border-radius: 9px;
        color: #4a5568;
        font-weight: 600;
        font-size: 0.85rem;
        padding: 8px 20px;
        transition: all 0.2s;
    }

    .nav-tabs-clinical .nav-link:hover {
        color: var(--prontmed-dark);
    }

    .nav-tabs-clinical .nav-link.active {
        background-color: #fff;
        color: var(--prontmed-blue-primary);
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    /* Editor de Texto */
    .clinical-card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .editor-toolbar {
        border-bottom: 1px solid #f0f4f8;
        padding: 10px 20px;
        display: flex;
        gap: 10px;
    }

    .editor-area {
        min-height: 400px;
        border: none;
        padding: 25px;
        font-size: 1rem;
        line-height: 1.6;
        color: #2d3748;
        resize: none;
        width: 100%;
        outline: none;
    }

    /* Timeline Lateral */
    .timeline-item {
        position: relative;
        padding-left: 20px;
        padding-bottom: 20px;
        border-left: 2px solid #edf2f7;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -7px;
        top: 0;
        width: 12px;
        height: 12px;
        background: #fff;
        border: 2px solid var(--prontmed-accent);
        border-radius: 50%;
    }

    /* Footer */
    .atendimento-footer {
        position: fixed;
        bottom: 0;
        right: 0;
        left: var(--prontmed-sidebar-width);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 1rem 2.5rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
    }

    .btn-action {
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        border-radius: 10px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

</style>

<div class="container-fluid p-0">
    <div class="d-flex atendimento-container">
        <!-- Sidebar -->
        <aside class="paciente-sidebar">
            <div class="profile-card text-center">
                <div class="avatar-wrapper">
                    <div class="avatar-main">
                        <i class="bi bi-person"></i>
                    </div>
                    <div class="status-indicator"></div>
                </div>
                <h5 class="fw-bold text-dark mb-1"><%= agendamento.paciente.nome %></h5>
                <p class="text-muted small mb-3">Prontuário: #00<%= agendamento.paciente.id %></p>
                <div class="d-flex justify-content-center gap-2">
                    <span class="badge bg-light text-dark border"><%= idade %> anos</span>
                    <span class="badge bg-light text-dark border">O+</span>
                </div>
            </div>

            <div class="p-4">
                <h6 class="text-uppercase fw-bold small text-muted mb-3">Informações de Contato</h6>
                <div class="mb-3">
                    <label class="d-block extra-small text-muted fw-bold">TELEFONE</label>
                    <span class="small fw-medium"><%= agendamento.paciente.telefone || '(11) 99999-9999' %></span>
                </div>
                <div class="mb-3">
                    <label class="d-block extra-small text-muted fw-bold">E-MAIL</label>
                    <span class="small fw-medium"><%= agendamento.paciente.email || 'guilherme.santos@exemplo.com' %></span>
                </div>

                <hr class="my-4 opacity-50">

                <h6 class="text-uppercase fw-bold small text-muted mb-3">Histórico de Visitas</h6>
                <div class="timeline-container mt-3">
                    <div class="timeline-item">
                        <span class="d-block extra-small fw-bold text-primary">HOJE</span>
                        <span class="small fw-bold">Consulta de Rotina</span>
                    </div>
                    <div class="timeline-item">
                        <span class="d-block extra-small text-muted">15 JAN 2026</span>
                        <span class="small text-muted">Retorno de Exames</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="prontuario-main">
            <!-- Header Stats -->
            <div class="patient-header-stats">
                <div class="stat-box">
                    <span class="stat-label">Último Peso</span>
                    <span class="stat-value">78.5 kg <i class="bi bi-arrow-down text-success small"></i></span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Pressão Art.</span>
                    <span class="stat-value">12/8 mmHg</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">IMC</span>
                    <span class="stat-value">24.2 <span class="badge bg-success ms-1" style="font-size: 0.6rem">Normal</span></span>
                </div>
                <div class="stat-box" style="border-left: 4px solid #f56565;">
                    <span class="stat-label">Alergias</span>
                    <span class="stat-value text-danger">Penicilina</span>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-end mb-3">
                <div>
                    <h3 class="fw-bold text-dark mb-0">Atendimento Clínico</h3>
                    <p class="text-muted small">Médico Responsável: Dr. <%= agendamento.medico.nome %></p>
                </div>
                <ul class="nav nav-tabs-clinical" id="atendimentoTabs">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-evolucao">Evolução</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-prescricao">Prescrição</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-exames">Exames</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-anexos">Anexos</a></li>
                </ul>
            </div>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-evolucao">
                    <div class="clinical-card">
                        <div class="editor-toolbar">
                            <button class="btn btn-sm btn-light border"><i class="bi bi-type-bold"></i></button>
                            <button class="btn btn-sm btn-light border"><i class="bi bi-type-italic"></i></button>
                            <button class="btn btn-sm btn-light border"><i class="bi bi-list-ul"></i></button>
                            <div class="vr mx-2"></div>
                            <button class="btn btn-sm btn-outline-primary ms-auto"><i class="bi bi-magic me-1"></i> Sugerir via IA</button>
                        </div>
                        <textarea class="editor-area" placeholder="Inicie a descrição da anamnese, exame físico e conduta médica..."></textarea>

                        <div class="p-4 bg-light border-top rounded-bottom">
                            <div class="row g-3">
                                <div class="col-md-5">
                                    <label class="stat-label">Diagnóstico Principal (CID-10)</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" placeholder="Ex: Z00.0">
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <label class="stat-label">Notas Internas (Não aparecem na impressão)</label>
                                    <input type="text" class="form-control" placeholder="Observações sigilosas...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-prescricao">
                    <div class="card border-0 shadow-sm p-5 text-center">
                        <i class="bi bi-capsule text-muted display-4 mb-3"></i>
                        <h5>Módulo de Prescrição Digital</h5>
                        <p class="text-muted">Clique no botão abaixo para adicionar medicamentos.</p>
                        <button class="btn btn-primary mx-auto" style="width: fit-content;">+ Novo Medicamento</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer Actions -->
    <footer class="atendimento-footer">
        <div class="d-flex gap-3">
            <button class="btn btn-light btn-action border text-muted">
                <i class="bi bi-clock-history"></i> Histórico Completo
            </button>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-action">
                <i class="bi bi-save"></i> Salvar Rascunho
            </button>
            <button class="btn btn-danger btn-action">
                <i class="bi bi-x-circle"></i> Cancelar
            </button>
            <button class="btn btn-primary btn-action px-5 shadow">
                <i class="bi bi-check2-all"></i> FINALIZAR CONSULTA
            </button>
        </div>
    </footer>
</div>
<script>
    // Script para gerenciar a largura da footer dinamicamente se necessário
    document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.querySelector('.paciente-sidebar');
        const footer = document.querySelector('.atendimento-footer');

        if (sidebar && footer) {
            const updateFooterWidth = () => {
                const sidebarWidth = sidebar.offsetWidth;
                footer.style.width = `calc(100% - ${sidebarWidth}px)`;
            };

            window.addEventListener('resize', updateFooterWidth);
            updateFooterWidth();
        }
    });
</script>